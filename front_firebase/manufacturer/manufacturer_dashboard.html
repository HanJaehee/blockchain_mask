<!doctype html>
<html lang="en">

<head>
    <title>MaskSaver Dashboard</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/data.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <!--     Fonts and icons     -->
    <link rel="stylesheet" type="text/css"
        href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" />
    <!--     Fonts and icons     -->
    <link rel="stylesheet" type="text/css"
        href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
    <!-- Material Kit CSS -->
    <link href="../assets/css/material-dashboard.css?v=2.1.2" rel="stylesheet" />
    <!-- Material Dashboard CSS -->
    <link rel="stylesheet" href="../assets/css/material-dashboard?v=2.1.2.css">

</head>

<body>

    <body>
        <div class="wrapper ">
            <div class="sidebar" data-color="purple" data-background-color="white">
                <!--
            Tip 1: You can change the color of the sidebar using: data-color="purple | azure | green | orange | danger"
      
            Tip 2: you can also add an image using data-image tag
        -->
                <div class="logo">
                    <a href="../index.html" class="simple-text logo-mini">
                        <img src="../assets/img/logo/logo.png" alt="">
                    </a>
                    <a class="simple-text logo-normal">
                        MaskSaver
                    </a>
                </div>
                <div class="sidebar-wrapper">
                    <ul class="nav">
                        <li class="nav-item active">
                            <a class="nav-link" href="../manufacturer/manufacturer_dashboard.html">
                                <i class="material-icons">dashboard</i>
                                <p>Dashboard</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../manufacturer/manufacturer_inventory.html">
                                <i class="material-icons">content_paste</i>
                                <p>재고 내역</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../manufacturer/manufacturer_makemask.html">
                                <i class="material-icons">bubble_chart</i>
                                <p>생성 내역</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../manufacturer/manufacturer_transaction.html">
                                <i class="material-icons">library_books</i>
                                <p>거래 내역</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../manufacturer/manufacturer_addmask.html">
                                <i class="material-icons">library_books</i>
                                <p>마스크 생성</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../manufacturer/manufacturer_sendmask.html">
                                <i class="material-icons">library_books</i>
                                <p>마스크 보내기</p>
                            </a>
                        </li>
                        <!-- your sidebar here -->
                    </ul>
                </div>
            </div>
            <div class="main-panel">
                <!-- Navbar -->
                <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
                    <div class="container-fluid">
                        <div class="navbar-wrapper">
                            <a class="navbar-brand" href="javascript:;">Dashboard</a>
                            <p id="id">여기는 유저 정보가 표시될 공간입니다.</p>
                        </div>

                        <button class="navbar-toggler" type="button" data-toggle="collapse"
                            aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="navbar-toggler-icon icon-bar"></span>
                            <span class="navbar-toggler-icon icon-bar"></span>
                            <span class="navbar-toggler-icon icon-bar"></span>
                        </button>
                        <div class="collapse navbar-collapse justify-content-end">
                            <form class="navbar-form">
                                <div class="input-group no-border">
                                    <div class="ripple-container"></div>
                                    </button>
                                </div>
                            </form>
                            <!-- <ul class="navbar-nav">
                                <li class="nav-item dropdown">
                                    <a class="nav-link" href="#0" id="navbarDropdownMenuLink" data-toggle="dropdown"
                                        aria-haspopup="true" aria-expanded="false">
                                        <i class="material-icons">notifications</i> Notifications
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right"
                                        aria-labelledby="navbarDropdownMenuLink">
                                        <a class="dropdown-item" href="#">A</a>
                                        <a class="dropdown-item" href="#">B</a> 
                                        <a class="dropdown-item" href="#">C</a>
                                        <a class="dropdown-item" href="#">D</a>
                                    </div>
                                </li>
                            your navbar here
                            </ul> -->
                        </div>
                    </div>
                </nav>
                <!-- End Navbar -->
                <div class="content">
                    <div class="container-fluid">
                        <!-- your content here -->
                        <div class="row">
                            <div class="col-lg-3 col-md-6 col-sm-6">
                                <div class="card">
                                    <div class="card-header card-header-text card-header-primary">
                                        <div class="card-text">
                                            <h4 class="card-title">재고</h4>
                                        </div>
                                    </div>
                                    <div class="card-body" id="inventory_cardbody"
                                        style="font-weight: bold; font-size: 40sp;">

                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-3 col-md-6 col-sm-6">
                                <div class="card">
                                    <div class="card-header card-header-text card-header-primary">
                                        <div class="card-text">
                                            <h4 class="card-title">생산량</h4>
                                        </div>
                                    </div>
                                    <div class="card-body" id="making_cardbody">
                                        The place is close to Barceloneta Beach and bus stop just 2 min by walk and near
                                        to "Naviglio" where you can enjoy the main night life in Barcelona...
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-6">
                                <div class="card">
                                    <div class="card-header card-header-text card-header-primary">
                                        <div class="card-text">
                                            <h4 class="card-title">거래량</h4>
                                        </div>
                                    </div>
                                    <div class="card-body" id="transaction_cardbody">
                                        The place is close to Barceloneta Beach and bus stop just 2 min by walk and near
                                        to "Naviglio" where you can enjoy the main night life in Barcelona...
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header card-header-danger">
                                        <h4 class="card-title">Notification</h4>
                                        <p class="category" id="notification_subtitle">Category subtitle</p>
                                    </div>
                                    <div class="card-body" id="notification_cardbody">
                                        
                                    </div>
                                </div>
                            </div>



                        </div>
                        <div class="row">
                            <div class="col-md-4">
                              <div class="card card-chart">
                                <div class="card-header card-header-success">
                                  <div class="ct-chart" id="dailySalesChart"></div>
                                </div>
                                <div class="card-body">
                                  <h4 class="card-title">Daily Sales</h4>
                                  <p class="card-category">
                                    <span class="text-success"><i class="fa fa-long-arrow-up"></i> 55% </span> increase in today sales.</p>
                                </div>
                                <div class="card-footer">
                                  <div class="stats">
                                    <i class="material-icons">access_time</i> updated 4 minutes ago
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="col-md-4">
                              <div class="card card-chart">
                                <div class="card-header card-header-warning">
                                  <div class="ct-chart" id="websiteViewsChart"></div>
                                </div>
                                <div class="card-body">
                                  <h4 class="card-title">Email Subscriptions</h4>
                                  <p class="card-category">Last Campaign Performance</p>
                                </div>
                                <div class="card-footer">
                                  <div class="stats">
                                    <i class="material-icons">access_time</i> campaign sent 2 days ago
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="col-md-4">
                              <div class="card card-chart">
                                <div class="card-header card-header-danger">
                                  <div class="ct-chart" id="completedTasksChart"></div>
                                </div>
                                <div class="card-body">
                                  <h4 class="card-title">Completed Tasks</h4>
                                  <p class="card-category">Last Campaign Performance</p>
                                </div>
                                <div class="card-footer">
                                  <div class="stats">
                                    <i class="material-icons">access_time</i> campaign sent 2 days ago
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                    </div>
                    <footer class="footer">
                        <div class="container-fluid">
                            <nav class="float-left">
                                <ul>
                                    <li>
                                        <a href="../index.html">
                                            MaskSaver
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </footer>
                </div>
            </div>

            <!-- <script>
        //테이블 행 클릭시 해당 정보 가져오는 JQuery  
          $("#addedMaskListTable tr").click(function(){     
       
       var str = "";
       var tdArr = new Array();    // 배열 선언
           
       // 현재 클릭된 Row(<tr>)
       var tr = $(this);
       var td = tr.children();
      
       // tr.text()는 클릭된 Row 즉 tr에 있는 모든 값을 가져온다.
       console.log("클릭한 Row의 모든 데이터 : "+tr.text());
                  
                  // 반복문을 이용해서 배열에 값을 담아 사용할 수 도 있다.
                  td.each(function(i){
                      tdArr.push(td.eq(i).text());
                  });
                          
                  $('#serialNumber2').val(tdArr[1]);
              
            
       });
       
      </script> -->


            <!--   Core JS Files   -->
            <script src="../assets/js/core/jquery.min.js" type="text/javascript"></script>
            <script src="../assets/js/core/popper.min.js" type="text/javascript"></script>
            <script src="../assets/js/core/bootstrap-material-design.min.js" type="text/javascript"></script>

            <!-- Plugin for the Perfect Scrollbar -->
            <script src="../assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>

            <!-- Plugin for the momentJs  -->
            <script src="../assets/js/plugins/moment.min.js"></script>

            <!--  Plugin for Sweet Alert -->
            <script src="../assets/js/plugins/sweetalert2.js"></script>

            <!-- Forms Validations Plugin -->
            <script src="../assets/js/plugins/jquery.validate.min.js"></script>

            <!--  Plugin for the Wizard, full documentation here: https://github.com/VinceG/twitter-bootstrap-wizard -->
            <script src="../assets/js/plugins/jquery.bootstrap-wizard.js"></script>

            <!--	Plugin for Select, full documentation here: http://silviomoreto.github.io/bootstrap-select -->
            <script src="../assets/js/plugins/bootstrap-selectpicker.js"></script>

            <!--  Plugin for the DateTimePicker, full documentation here: https://eonasdan.github.io/bootstrap-datetimepicker/ -->
            <script src="../assets/js/plugins/bootstrap-datetimepicker.min.js"></script>

            <!--  DataTables.net Plugin, full documentation here: https://datatables.net/    -->
            <script src="../assets/js/plugins/jquery.datatables.min.js"></script>

            <!--	Plugin for Tags, full documentation here: https://github.com/bootstrap-tagsinput/bootstrap-tagsinputs  -->
            <script src="../assets/js/plugins/bootstrap-tagsinput.js"></script>

            <!-- Plugin for Fileupload, full documentation here: http://www.jasny.net/bootstrap/javascript/#fileinput -->
            <script src="../assets/js/plugins/jasny-bootstrap.min.js"></script>

            <!--  Full Calendar Plugin, full documentation here: https://github.com/fullcalendar/fullcalendar    -->
            <script src="../assets/js/plugins/fullcalendar.min.js"></script>

            <!-- Vector Map plugin, full documentation here: http://jvectormap.com/documentation/ -->
            <script src="../assets/js/plugins/jquery-jvectormap.js"></script>

            <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
            <script src="../assets/js/plugins/nouislider.min.js"></script>

            <!-- Include a polyfill for ES6 Promises (optional) for IE11, UC Browser and Android browser support SweetAlert -->
            <script src="../https://cdnjs.cloudflare.com/ajax/libs/core-js/2.4.1/core.js"></script>

            <!-- Library for adding dinamically elements -->
            <script src="../assets/js/plugins/arrive.min.js"></script>

            <!--  Google Maps Plugin    -->
            <script src="../https://maps.googleapis.com/maps/api/js?key=YOUR_KEY_HERE"></script>

            <!-- Chartist JS -->
            <script src="../assets/js/plugins/chartist.min.js"></script>

            <!--  Notifications Plugin    -->
            <script src="../assets/js/plugins/bootstrap-notify.js"></script>

            <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
            <script src="../assets/js/material-dashboard.js?v=2.1.2" type="text/javascript"></script>
            <script src="../assets/vendor/jquery/jquery-3.2.1.min.js"></script>
            <!-- 합쳐지고 최소화된 최신 자바스크립트 -->
            <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
            <!-- The core Firebase JS SDK is always required and must be listed first -->
            <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-app.js"></script>
            <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js">
            </script>
            <!-- TODO: Add SDKs for Firebase products that you want to use
       https://firebase.google.com/docs/web/setup#available-libraries -->
            <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-analytics.js"></script>
            <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-auth.js"></script>
            <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-database.js"></script>
            <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-firestore.js"></script>
            <script src="../assets/js/firebaseInit.js"></script>
            <script src="../assets/js/firebaseUserCheck.js"></script>
            <script src="../assets/js/myfunctions.js"></script>
            <script src="../assets/js/material-dashboard.js"></script>
            <script src="../assets/js/material-dashboard.js.map"></script>
            <script src="../assets/js/material-dashboard.min.js"></script>
            <script>
                userSessionCheck();
            </script>
            <script>
                //마스크 추가 함수
                function AddMask() {
                    var ourRequest = new XMLHttpRequest();

                    //위의 변수를 가지고 web3를 통해 컨트랙트 함수 실행
                    ourRequest.open('GET',
                        'https://us-central1-maskproject-6e385.cloudfunctions.net/maskSaver/maskMaking/' +
                        firebaseEmailAuth.currentUser.uid);
                    ourRequest.onload = function () {
                        var ourData = JSON.parse(ourRequest.responseText);
                        console.log(ourData);
                        IsSuccessOrFail(ourData);
                    };
                    ourRequest.send();

                }

                function getInventorySize() {
                    console.log("getInventorySize() 호출");
                    var ourRequest = new XMLHttpRequest();
                    ourRequest.open('GET',
                        'https://us-central1-maskproject-6e385.cloudfunctions.net/maskSaver/getHistory/' +
                        userAddr);
                    ourRequest.onload = function () {
                        var ourData = JSON.parse(ourRequest.responseText);
                        console.log("inventory size : " + ourData);
                        setInventoryCardbody(ourData);
                    };
                    ourRequest.send();
                }

                function setInventoryCardbody(data) {
                    console.log("setInventoryCardbody() 호출");
                    $('#inventory_cardbody').append(data.stockList.length);
                }
                //마스크 보내기 함수
                function SendMask() {
                    var serialNumber = document.getElementById("serialNumber2").value;
                    var toDistributor = document.getElementById("toDistributor").value;
                    console.log(serialNumber, toDistributor);
                    //위의 변수를 가지고 web3를 통해 컨트랙트 함수 실행
                    var ourRequest = new XMLHttpRequest();
                    ourRequest.open('GET',
                        'https://us-central1-maskproject-6e385.cloudfunctions.net/maskSaver/dealMasks/' +
                        firebaseEmailAuth.currentUser.uid + '/' +
                        toDistributor +
                        '/' + serialNumber);
                    ourRequest.onload = function () {
                        var ourData = JSON.parse(ourRequest.responseText);
                        console.log(ourData);
                        IsSuccessOrFail(ourData);
                    };
                    ourRequest.send();

                }
                //마스크 생성내역 테이블 만드는 함수
                function MakeAddedMaskListTable() {
                    var myTbody = document.getElementById("maskListTbody");
                    var ourRequest = new XMLHttpRequest();
                    var exampleInfo = document.getElementById("exampleInfo");

                    ourRequest.open('GET',
                        'https://us-central1-maskproject-6e385.cloudfunctions.net/maskSaver/getHistory/' +
                        userAddr);
                    ourRequest.onload = function () {
                        var ourData = JSON.parse(ourRequest.responseText);
                        console.log(ourData);
                        renderMakeTransactionHTML(ourData);

                        //테이블 행 클릭시 해당 정보 가져오는 JQuery  
                        $("#inventoryTable tr").click(function () {

                            var str = "";
                            var tdArr = new Array(); // 배열 선언

                            // 현재 클릭된 Row(<tr>)
                            var tr = $(this);
                            var td = tr.children();

                            // tr.text()는 클릭된 Row 즉 tr에 있는 모든 값을 가져온다.
                            console.log("클릭한 Row의 모든 데이터 : " + tr.text());

                            // 반복문을 이용해서 배열에 값을 담아 사용할 수 도 있다.
                            td.each(function (i) {
                                tdArr.push(td.eq(i).text());
                            });

                            $('#serialNumber2').val(tdArr[1]);


                        });
                    };
                    ourRequest.send();
                }
                //거래내역 테이블 만드는 함수
                function MakeTransactionListTable() {
                    var myTbody = document.getElementById("maskListTbody");
                    var ourRequest = new XMLHttpRequest();
                    var exampleInfo = document.getElementById("exampleInfo");

                    ourRequest.open('GET',
                        'https://us-central1-maskproject-6e385.cloudfunctions.net/maskSaver/getHistory/' +
                        userAddr);
                    ourRequest.onload = function () {
                        var ourData = JSON.parse(ourRequest.responseText);
                        console.log(ourData);
                        renderMakeAddedMaskHTML(ourData);
                    };
                    ourRequest.send();
                }
                //재고내역 테이블 만드는 함수
                function MakeInventoryTable() {
                    var myTbody = document.getElementById("salesHistoryTbody");
                    var ourRequest = new XMLHttpRequest();
                    ourRequest.open('GET',
                        'https://us-central1-maskproject-6e385.cloudfunctions.net/maskSaver/getHistory/' +
                        userAddr);
                    ourRequest.onload = function () {
                        var ourData = JSON.parse(ourRequest.responseText);
                        console.log(ourData);
                        renderInventoryHTML(ourData);
                    };
                    ourRequest.send();
                }

                function renderInventoryHTML(data) {
                    var htmlString = "";
                    sortByDate(data.stockList);
                    for (i = 0; i < data.stockList.length; i++) {
                        console.log("renderInventoryHTML");
                        htmlString += "<tr><td>" + new Date(data.stockList[i].time * 1000).toLocaleString() + "</td>";
                        htmlString += "<td>" + data.stockList[i].tokenId + "</td>";
                        htmlString += "<td>" + data.stockList[i].num + "</td></tr>";
                    }
                    $("#inventoryTbody").append(htmlString);
                }

                function renderMakeAddedMaskHTML(data) {
                    var htmlString = "";
                    sortByDate(data.enteredHistory);
                    for (i = 0; i < data.enteredHistory.length; i++) {
                        htmlString += "<tr><td>" + new Date(data.enteredHistory[i].time * 1000).toLocaleString() +
                            "</td>";
                        htmlString += "<td>" + data.enteredHistory[i].tokenId + "</td>";
                        htmlString += "<td>" + data.enteredHistory[i].num + "</td></tr>";
                    }
                    $("#maskListTbody").append(htmlString);
                }


                function renderMakeTransactionHTML(data) {
                    var htmlString = "";
                    sortByDate(data.releasedHistory);
                    for (i = 0; i < data.releasedHistory.length; i++) {
                        htmlString += "<tr><td>" + new Date(data.releasedHistory[i].time * 1000).toLocaleString() +
                            "</td>";
                        htmlString += "<td>" + data.releasedHistory[i].tokenId + "</td>";
                        htmlString += "<td>" + data.releasedHistory[i].num + "</td>";
                        htmlString += "<td>" + data.releasedHistory[i].from + "</td>";
                        htmlString += "<td>" + data.releasedHistory[i].to + "</td></tr>";
                    }
                    $("#transactionListTbody").append(htmlString);
                }
            </script>
<script>
    function getUidFromAddr(addr){
        console.log("foo 실행");
      db.collection("users").where("addr", "==", addr)
    .get()
    .then(function(querySnapshot) {
        querySnapshot.forEach(function(doc) {
            // doc.data() is never undefined for query doc snapshots
            console.log(doc.id, " => ", doc.data());
        });
    })
    .catch(function(error) {
        console.log("Error getting documents: ", error);
    });
    }
  </script>
            <!-- httpRequest JSON parsing script -->
            <script type="text/javascript">
                firebaseEmailAuth.onAuthStateChanged(function (user) {

                    if (user) {
                        //로그인 성공한 유저 id 확인해 보기 - firebase database에 접근해서 데이터 조회 하는 함수
                        var docRef = db.collection("users").doc(firebaseEmailAuth.currentUser.uid);

                        docRef.get().then(function (doc) {
                            if (doc.exists) {
                                userAddr = doc.data().addr;
                                userName = doc.data().name;
                                userEmail = user.email;
                                console.log(user.email + " 님이 로그인했습니다." + " 계좌 : " + userAddr +
                                    " 이름 :" + userName);
                                getInventorySize();
                                getDaily();
                                getWarningList();
                                getUidFromAddr("0xEC8CA2aA6C02f9d81c610B9bCb8F840e746F058e");
                            } else {
                                // doc.data() will be undefined in this case
                                console.log("No such document!");
                            }
                        }).catch(function (error) {
                            console.log("Error getting document:", error);
                        });



                        //자바스크립트 dom 선택자를 통해서 네비게이션 메뉴의 엘리먼트 변경해주기


                        //alert(userInfo.userid);  //uid는 db에서 user 테이블의 각 개체들의 pk 인데, 이 값은 인증에서 생성된 아이디의 pk 값과 같다. *중요!

                        return true;
                    }
                });
                //일일 입고량 판매량 가져오는 함수
                function getDaily() {
                    var today = new Date();
                    today = moment(today).format('YYYY-MM-DD');
                    var docRef4 = db.collection("users").doc(firebaseEmailAuth.currentUser.uid).collection('daily').doc(
                        today);

                    console.log("today = ", today);
                    var result = "";
                    docRef4.get().then(function (doc) {
                        if (doc.exists) {
                            result = doc.data()
                            console.log("Document data:", doc.data());
                        } else {
                            // doc.data() will be undefined in this case
                            console.log("No such document!");
                            return;
                        }
                    }).catch(function (error) {
                        console.log("Error getting document:", error);
                    });
                }
                
            </script>
            <script>
                getInventorySize();
            </script>
    
    <script> 
    Highcharts.chart('container', {
        data: {
            table: 'datatable'
        },
        chart: {
            type: 'column'
        },
        title: {
            text: '재고'
        },
        yAxis: {
            allowDecimals: false,
            title: {
                text: 'Units'
            }
        },
    });
    </script>
    <script>
        $(document).ready(function() {
          // Javascript method's body can be found in assets/js/demos.js
          md.initDashboardPageCharts();
    
        });
      </script>
    </body>

</html>