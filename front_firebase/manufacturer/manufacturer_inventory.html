<!doctype html>
<html lang="en">

<head>
  <title>MaskSaver Dashboard</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  <!-- Material Kit CSS -->
  <link href="../assets/css/material-dashboard.css?v=2.1.2" rel="stylesheet" />
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  <script src="https://code.highcharts.com/js/themes/grid-light.js"></script>

  <style>
    .highcharts-figure, .highcharts-data-table table {
    min-width: 310px; 
    max-width: 1200px;
    margin: 1em auto;
}

#container {
    height: 400px;
}

.highcharts-data-table table {
	font-family: Verdana, sans-serif;
	border-collapse: collapse;
	border: 1px solid #EBEBEB;
	margin: 10px auto;
	text-align: center;
	width: 100%;
	max-width: 500px;
}
.highcharts-data-table caption {
    padding: 1em 0;
    font-size: 1.2em;
    color: #555;
}
.highcharts-data-table th {
	font-weight: 600;
    padding: 0.5em;
}
.highcharts-data-table td, .highcharts-data-table th, .highcharts-data-table caption {
    padding: 0.5em;
}
.highcharts-data-table thead tr, .highcharts-data-table tr:nth-child(even) {
    background: #f8f8f8;
}
.highcharts-data-table tr:hover {
    background: #f1f7ff;
}

  </style>
</head>

<body>
  <div class="wrapper ">
    <div class="sidebar" data-color="purple" data-background-color="white">
      <!--
      Tip 1: You can change the color of the sidebar using: data-color="purple | azure | green | orange | danger"

      Tip 2: you can also add an image using data-image tag
  -->
      <div class="logo">
        <a href="../index.html" class="simple-text logo-mini">
          <img src="../assets/img/logo/logo.png" alt="">
        </a>
        <a class="simple-text logo-normal">
          MaskSaver
        </a>
      </div>
      <div class="sidebar-wrapper">
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link" href="../manufacturer/manufacturer_dashboard.html">
              <i class="material-icons">dashboard</i>
              <p>Dashboard</p>
            </a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="../manufacturer/manufacturer_inventory.html">
              <i class="material-icons">content_paste</i>
              <p>재고 내역</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="../manufacturer/manufacturer_makemask.html">
              <i class="material-icons">bubble_chart</i>
              <p>생성 내역</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="../manufacturer/manufacturer_transaction.html">
              <i class="material-icons">library_books</i>
              <p>거래 내역</p>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="../manufacturer/manufacturer_addmask.html">
                <i class="material-icons">library_books</i>
                <p>마스크 생성</p>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="../manufacturer/manufacturer_sendmask.html">
                <i class="material-icons">library_books</i>
                <p>마스크 보내기</p>
            </a>
        </li>
          <!-- your sidebar here -->
        </ul>
      </div>
    </div>
    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <a class="navbar-brand" href="javascript:;">Dashboard</a>
          </div>
          <div class="alert alert-primary" role="alert">
            <a id="id">여기는 유저 정보가 표시될 공간입니다.</a>
          </div>
          <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>주의사항!</strong> 당신의 마스크가 곧 위법으로 바뀝니다.
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->
      <div class="content">
        <div class="container-fluid">
          <!-- your content here -->

          <figure class="highcharts-figure">
              <div id="container"></div>
          </figure>

          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header card-header-primary">
                  <h4 class="card-title ">재고내역</h4>
                  <p class="card-category"> 현재 귀하가 가지고 있는 재고입니다.</p>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table">
                      <thead class=" text-primary">
                        <th>
                          제조일자
                        </th>
                        <th>
                          일련번호
                        </th>
                        <th>
                          개수
                        </th>
                       
                      </thead>
                      <tbody id="inventoryTbody">
                       
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
        </div>
      </div>
      <footer class="footer">
        <div class="container-fluid">
          <nav class="float-left">
            <ul>
              <li>
                <a href="../index.html">
                  MaskSaver
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </footer>
    </div>
  </div>
  <script src="../assets/vendor/jquery/jquery-3.2.1.min.js"></script>
      <!-- 합쳐지고 최소화된 최신 자바스크립트 -->
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
      <!-- The core Firebase JS SDK is always required and must be listed first -->
      <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-app.js"></script>
  
      <!-- TODO: Add SDKs for Firebase products that you want to use
           https://firebase.google.com/docs/web/setup#available-libraries -->
      <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-firestore.js"></script>
  <script src="../assets/js/firebaseInit.js"></script>
  <script src="../assets/js/firebaseUserCheck.js"></script>
  <script src="../assets/js/myfunctions.js"></script>
<script src="../assets/js/material-dashboard.js"></script>
<script src="../assets/js/material-dashboard.js.map"></script>
<script src="../assets/js/material-dashboard.min.js"></script>
  <script>
    userSessionCheck();
  </script>
  <script>
    //마스크 추가 함수
    function AddMask() {
      var ourRequest = new XMLHttpRequest();

      //위의 변수를 가지고 web3를 통해 컨트랙트 함수 실행
      ourRequest.open('GET', 'https://us-central1-maskproject-6e385.cloudfunctions.net/maskSaver/maskMaking/' +
        firebaseEmailAuth.currentUser.uid);
      ourRequest.onload = function () {
        var ourData = JSON.parse(ourRequest.responseText);
        console.log(ourData);
        IsSuccessOrFail(ourData);
      };
      ourRequest.send();

    }
    //마스크 보내기 함수
    function SendMask() {
      var serialNumber = document.getElementById("serialNumber2").value;
      var toDistributor = document.getElementById("toDistributor").value;
      console.log(serialNumber, toDistributor);
      //위의 변수를 가지고 web3를 통해 컨트랙트 함수 실행
      var ourRequest = new XMLHttpRequest();
      ourRequest.open('GET', 'https://us-central1-maskproject-6e385.cloudfunctions.net/maskSaver/dealMasks/' +
        firebaseEmailAuth.currentUser.uid + '/' +
        toDistributor +
        '/' + serialNumber);
      ourRequest.onload = function () {
        var ourData = JSON.parse(ourRequest.responseText);
        console.log(ourData);
        IsSuccessOrFail(ourData);
      };
      ourRequest.send();

    }
    //마스크 생성내역 테이블 만드는 함수
    function MakeAddedMaskListTable() {
      var myTbody = document.getElementById("maskListTbody");
      var ourRequest = new XMLHttpRequest();
      var exampleInfo = document.getElementById("exampleInfo");

      ourRequest.open('GET', 'https://us-central1-maskproject-6e385.cloudfunctions.net/maskSaver/getHistory/' +
        userAddr);
      ourRequest.onload = function () {
        var ourData = JSON.parse(ourRequest.responseText);
        console.log(ourData);
        renderMakeTransactionHTML(ourData);

        //테이블 행 클릭시 해당 정보 가져오는 JQuery  
        $("#inventoryTable tr").click(function () {

          var str = "";
          var tdArr = new Array(); // 배열 선언

          // 현재 클릭된 Row(<tr>)
          var tr = $(this);
          var td = tr.children();

          // tr.text()는 클릭된 Row 즉 tr에 있는 모든 값을 가져온다.
          console.log("클릭한 Row의 모든 데이터 : " + tr.text());

          // 반복문을 이용해서 배열에 값을 담아 사용할 수 도 있다.
          td.each(function (i) {
            tdArr.push(td.eq(i).text());
          });

          $('#serialNumber2').val(tdArr[1]);


        });
      };
      ourRequest.send();
    }
    //거래내역 테이블 만드는 함수
    function MakeTransactionListTable() {
      var myTbody = document.getElementById("maskListTbody");
      var ourRequest = new XMLHttpRequest();
      var exampleInfo = document.getElementById("exampleInfo");

      ourRequest.open('GET', 'https://us-central1-maskproject-6e385.cloudfunctions.net/maskSaver/getHistory/' +
        userAddr);
      ourRequest.onload = function () {
        var ourData = JSON.parse(ourRequest.responseText);
        console.log(ourData);
        renderMakeAddedMaskHTML(ourData);
      };
      ourRequest.send();
    }
    //재고내역 테이블 만드는 함수
    function MakeInventoryTable() {
      var myTbody = document.getElementById("salesHistoryTbody");
      var ourRequest = new XMLHttpRequest();
      ourRequest.open('GET', 'https://us-central1-maskproject-6e385.cloudfunctions.net/maskSaver/getHistory/' +
        userAddr);
      ourRequest.onload = function () {
        var ourData = JSON.parse(ourRequest.responseText);
        console.log(ourData);
        renderInventoryHTML(ourData);
      };
      ourRequest.send();
    }
    
    function renderInventoryHTML(data) {
      var htmlString = "";
      sortByDate(data.stockList);
      for (i = 0; i < data.stockList.length; i++) {
        console.log("renderInventoryHTML");
        htmlString += "<tr><td>" + new Date(data.stockList[i].time * 1000).toLocaleString() + "</td>";
        htmlString += "<td>" + data.stockList[i].tokenId + "</td>";
        htmlString += "<td>" + data.stockList[i].num + "</td></tr>";
      }
      $("#inventoryTbody").append(htmlString);
    }

    function renderMakeAddedMaskHTML(data) {
      var htmlString = "";
      sortByDate(data.enteredHistory);
      for (i = 0; i < data.enteredHistory.length; i++) {
        htmlString += "<tr><td>" + new Date(data.enteredHistory[i].time * 1000).toLocaleString() + "</td>";
        htmlString += "<td>" + data.enteredHistory[i].tokenId + "</td>";
        htmlString += "<td>" + data.enteredHistory[i].num + "</td></tr>";
      }
      $("#maskListTbody").append(htmlString);
    }


    function renderMakeTransactionHTML(data) {
      var htmlString = "";
      sortByDate(data.releasedHistory);
      for (i = 0; i < data.releasedHistory.length; i++) {
        htmlString += "<tr><td>" + new Date(data.releasedHistory[i].time * 1000).toLocaleString() + "</td>";
        htmlString += "<td>" + data.releasedHistory[i].tokenId + "</td>";
        htmlString += "<td>" + data.releasedHistory[i].num + "</td>";
        htmlString += "<td>" + data.releasedHistory[i].from + "</td>";
        htmlString += "<td>" + data.releasedHistory[i].to + "</td></tr>";
      }
      $("#transactionListTbody").append(htmlString);
    }
  </script>

  <!-- httpRequest JSON parsing script -->
  <script type="text/javascript">
    firebaseEmailAuth.onAuthStateChanged(function (user) {

      if (user) {
        //로그인 성공한 유저 id 확인해 보기 - firebase database에 접근해서 데이터 조회 하는 함수
        var docRef = db.collection("users").doc(firebaseEmailAuth.currentUser.uid);

        docRef.get().then(function (doc) {
          if (doc.exists) {
            userAddr = doc.data().addr;
            userName = doc.data().name;
            userEmail = user.email;
            console.log(user.email + " 님이 로그인했습니다." + " 계좌 : " + userAddr + " 이름 :" + userName);
            MakeTransactionListTable();
            MakeAddedMaskListTable();
            MakeInventoryTable();
          } else {
            // doc.data() will be undefined in this case
            console.log("No such document!");
          }
        }).catch(function (error) {
          console.log("Error getting document:", error);
        });



        //자바스크립트 dom 선택자를 통해서 네비게이션 메뉴의 엘리먼트 변경해주기


        //alert(userInfo.userid);  //uid는 db에서 user 테이블의 각 개체들의 pk 인데, 이 값은 인증에서 생성된 아이디의 pk 값과 같다. *중요!

        return true;
      }
    });
  </script>
  <!-- <script>
  //테이블 행 클릭시 해당 정보 가져오는 JQuery  
    $("#addedMaskListTable tr").click(function(){     
 
 var str = "";
 var tdArr = new Array();    // 배열 선언
     
 // 현재 클릭된 Row(<tr>)
 var tr = $(this);
 var td = tr.children();

 // tr.text()는 클릭된 Row 즉 tr에 있는 모든 값을 가져온다.
 console.log("클릭한 Row의 모든 데이터 : "+tr.text());
            
            // 반복문을 이용해서 배열에 값을 담아 사용할 수 도 있다.
            td.each(function(i){
                tdArr.push(td.eq(i).text());
            });
                    
            $('#serialNumber2').val(tdArr[1]);
        
      
 });
 
</script> -->
  <script>
    Highcharts.chart('container', {
        credits: {
            enabled: false
        }, 
        chart: {
            type: 'column'
        },
        title: {
            text: '생산량, 재고량, 거래량 추이'
        },
        subtitle: {
            text: 'from MaskSaver'
        },
        xAxis: {
            categories: [
                '2020-05-29',
                '2020-05-30',
                '2020-05-31',
                '2020-06-01',
                '2020-06-02',
                '2020-06-03',
                '2020-06-04',
                '2020-06-05',
                '2020-06-06',
                '2020-06-07',
                '2020-06-08',
                '2020-06-09'
            ],
            crosshair: true
        },
        yAxis: {
            min: 0,
            title: {
                text: 'Quantity (box)'
            }
        },
        tooltip: {
            headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
            pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                '<td style="padding:0"><b>{point.y:.1f} mm</b></td></tr>',
            footerFormat: '</table>',
            shared: true,
            useHTML: true
        },
        plotOptions: {
            column: {
                pointPadding: 0.2,
                borderWidth: 0
            }
        },
        series: [{
            name: '재고량',
            data: [20000, 36000, 41000, 28000, 33000, 48000, 42000, 37000, 29000, 27000, 36000, 45000]
    
        }, {
            name: '생산량',
            data: [16000, 10000, 13000, 18000, 22000, 15000, 14000, 17000, 25000, 24000, 26000, 28000]
    
        }, {
            name: '거래량',
            data: [15000, 30000, 28000, 18000, 15000, 30000, 28000, 18000, 15000, 30000, 28000, 18000]
    
        }]
    });

  </script>
</body>

</html>