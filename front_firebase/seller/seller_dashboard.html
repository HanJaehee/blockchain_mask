<!doctype html>
<html lang="en">

<head>
    <title>MaskSaver Dashboard</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/data.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://code.highcharts.com/js/themes/grid-light.js"></script> <!-- chrom 탭-->

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <!--     Fonts and icons     -->
    <link rel="stylesheet" type="text/css"
        href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
    <!-- Material Kit CSS -->
    <link href="../assets/css/material-dashboard.css" rel="stylesheet" />
    <!-- Material Dashboard CSS -->
    <link rel="stylesheet" href="../assets/css/material-dashboard.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.perfect-scrollbar/0.6.7/js/min/perfect-scrollbar.jquery.min.js"></script>
    <!-- 이 위에 두줄은 material-dashboard.min.js 랑 material-dashboard.js에서 찾을수없다고 해서 추가 -->
    <style>
        .highcharts-figure,
        .highcharts-data-table table {
            min-width: 310px;
            max-width: 1200px;
            margin: 1em auto;
        }

        #container {
            height: 400px;
        }

        .highcharts-data-table table {
            font-family: Verdana, sans-serif;
            border-collapse: collapse;
            border: 1px solid #EBEBEB;
            margin: 10px auto;
            text-align: center;
            width: 100%;
            max-width: 500px;
        }

        .highcharts-data-table caption {
            padding: 1em 0;
            font-size: 1.2em;
            color: #555;
        }

        .highcharts-data-table th {
            font-weight: 600;
            padding: 0.5em;
        }

        .highcharts-data-table td,
        .highcharts-data-table th,
        .highcharts-data-table caption {
            padding: 0.5em;
        }

        .highcharts-data-table thead tr,
        .highcharts-data-table tr:nth-child(even) {
            background: #f8f8f8;
        }

        .highcharts-data-table tr:hover {
            background: #f1f7ff;
        }
    </style>
</head>

    <body>
        <div class="wrapper ">
            <div class="sidebar" data-color="purple" data-background-color="white">
                <div class="logo">
                    <a href="../index.html" class="simple-text logo-mini">
                        <img src="../assets/img/logo/logo.png" alt="">
                    </a>
                    <a class="simple-text logo-normal">
                        MaskSaver
                    </a>
                </div>
                <div class="sidebar-wrapper">
                    <ul class="nav">
                      <li class="nav-item active ">
                        <a class="nav-link" href="../seller/seller_dashboard.html">
                          <i class="material-icons">dashboard</i>
                          <p>Dashboard</p>
                        </a>
                      </li>
                      <li class="nav-item ">
                        <a class="nav-link" href="../seller/seller_inventory.html">
                          <i class="material-icons">content_paste</i>
                          <p>재고 내역</p>
                        </a>
                      </li>
                      <li class="nav-item ">
                        <a class="nav-link" href="../seller/seller_sold.html">
                          <i class="material-icons">bubble_chart</i>
                          <p>판매 내역</p>
                        </a>
                      </li>
                      <li class="nav-item ">
                        <a class="nav-link" href="../seller/seller_receipt.html">
                          <i class="material-icons">library_books</i>
                          <p>입고 내역</p>
                        </a>
                      </li>
                      <li class="nav-item ">
                        <a class="nav-link" href="../seller/seller_sell.html">
                          <i class="material-icons">library_books</i>
                          <p>판매하기</p>
                        </a>
                      </li>
                      <!-- your sidebar here -->
                    </ul>
                        <!-- your sidebar here -->
                    </ul>
                </div>
            </div>
            <div class="main-panel">
                <!-- Navbar -->
                <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top">

                    <div class="container-fluid">
                        <div class="navbar-wrapper">
                        
                    <!--
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <strong>경고!</strong> 마스크 재고의 잔여 가능 보유일을 확인하세요.
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    -->
                        <div class="alert alert-info hr" role="alert">
                            <a id="userInfo">로그인시 유저 정보가 보입니다.</a>
                        </div>
                    </div>
                </nav>
                <!-- End Navbar -->
                <div class="content">
                    <div class="row"> <!-- 상단 카드부분 -->
                        <div class="col-md-4 col-sm-4">
                            <div class="card card-stats">
                                <div class="card-header card-header-primary card-header-icon">
                                  <div class="card-icon">
                                      <i class="material-icons">table_rows</i>
                                  </div>
                                  <p class="card-category">현재 재고량</p>
                                  <h3 class="card-title" id="stock"> 가져오는중 ..</h3>
                                </div>
                                <div class="card-footer">
                                    <div class="stats">
                                        <i class="material-icons text-danger">warning</i>
                                        <a href="http://localhost:5000/manufacturer/manufacturer_inventory.html">보관 기간이 7일 근처인 재고가 있습니다...</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 col-sm-4">
                            <div class="card card-stats">
                                <div class="card-header card-header-success card-header-icon">
                                  <div class="card-icon">
                                    <i class="material-icons">add_shopping_cart</i>
                                  </div>
                                  <p class="card-category">오늘의 입고량</p>
                                  <h3 class="card-title" id="entered"> 가져오는중 ..</h3>
                                </div>
                                <div class="card-footer">
                                    <div class="stats">
                                        
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 col-sm-4">
                            <div class="card card-stats">
                                <div class="card-header card-header-info card-header-icon">
                                  <div class="card-icon">
                                    <i class="material-icons">local_pharmacy</i>
                                  </div>
                                  <p class="card-category">오늘의 판매량</p>
                                  <h3 class="card-title" id="released"> 가져오는중 ..</h3>
                                </div>
                                <div class="card-footer">
                                    <div class="stats">
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                      
                    </div>
                    <div class="container-fluid">
                        <!-- your content here -->
                        

                        <figure class="highcharts-figure">
                            <div id="container"></div>
                        </figure>

                    
                    </div>
                </div>
                <footer class="footer">
                    <div class="container-fluid">
                        <nav class="float-left">
                            <ul>
                                <li>
                                    <a href="../index.html">
                                        MaskSaver
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </footer>
            </div>
        </div>

        <!-- <script>
        //테이블 행 클릭시 해당 정보 가져오는 JQuery  
          $("#addedMaskListTable tr").click(function(){     
       
       var str = "";
       var tdArr = new Array();    // 배열 선언
           
       // 현재 클릭된 Row(<tr>)
       var tr = $(this);
       var td = tr.children();
      
       // tr.text()는 클릭된 Row 즉 tr에 있는 모든 값을 가져온다.
       console.log("클릭한 Row의 모든 데이터 : "+tr.text());
                  
                  // 반복문을 이용해서 배열에 값을 담아 사용할 수 도 있다.
                  td.each(function(i){
                      tdArr.push(td.eq(i).text());
                  });
                          
                  $('#serialNumber2').val(tdArr[1]);
              
            
       });
       
      </script> -->


        <!--   Core JS Files   -->
        <script src="../assets/js/core/jquery.min.js" type="text/javascript"></script>
        <script src="../assets/js/core/popper.min.js" type="text/javascript"></script>
        <script src="../assets/js/core/bootstrap-material-design.min.js" type="text/javascript"></script>

        <!-- Plugin for the Perfect Scrollbar -->
        <script src="../assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>

        <!-- Plugin for the momentJs  -->
        <script src="../assets/js/plugins/moment.min.js"></script>

        <!--  Plugin for Sweet Alert -->
        <script src="../assets/js/plugins/sweetalert2.js"></script>

        <!-- Forms Validations Plugin -->
        <script src="../assets/js/plugins/jquery.validate.min.js"></script>

        <!--  Plugin for the Wizard, full documentation here: https://github.com/VinceG/twitter-bootstrap-wizard -->
        <script src="../assets/js/plugins/jquery.bootstrap-wizard.js"></script>

        <!--	Plugin for Select, full documentation here: http://silviomoreto.github.io/bootstrap-select -->
        <script src="../assets/js/plugins/bootstrap-selectpicker.js"></script>

        <!--  Plugin for the DateTimePicker, full documentation here: https://eonasdan.github.io/bootstrap-datetimepicker/ -->
        <script src="../assets/js/plugins/bootstrap-datetimepicker.min.js"></script>

        <!--  DataTables.net Plugin, full documentation here: https://datatables.net/    -->
        <script src="../assets/js/plugins/jquery.datatables.min.js"></script>

        <!--	Plugin for Tags, full documentation here: https://github.com/bootstrap-tagsinput/bootstrap-tagsinputs  -->
        <script src="../assets/js/plugins/bootstrap-tagsinput.js"></script>

        <!-- Plugin for Fileupload, full documentation here: http://www.jasny.net/bootstrap/javascript/#fileinput -->
        <script src="../assets/js/plugins/jasny-bootstrap.min.js"></script>

        <!--  Full Calendar Plugin, full documentation here: https://github.com/fullcalendar/fullcalendar    -->
        <script src="../assets/js/plugins/fullcalendar.min.js"></script>

        <!-- Vector Map plugin, full documentation here: http://jvectormap.com/documentation/ -->
        <script src="../assets/js/plugins/jquery-jvectormap.js"></script>

        <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
        <script src="../assets/js/plugins/nouislider.min.js"></script>

        <!-- Include a polyfill for ES6 Promises (optional) for IE11, UC Browser and Android browser support SweetAlert -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.4.1/core.js"></script>
        <!-- 링크인데 ../되어있어서 뺌-->
        <!-- Library for adding dinamically elements -->
        <script src="../assets/js/plugins/arrive.min.js"></script>

        <!--  Google Maps Plugin   안써서 지움
        <script src="../https://maps.googleapis.com/maps/api/js?key=YOUR_KEY_HERE"></script>
        -->
        <!-- Chartist JS -->
        <script src="../assets/js/plugins/chartist.min.js"></script>

        <!--  Notifications Plugin    -->
        <script src="../assets/js/plugins/bootstrap-notify.js"></script>

        <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
        <script src="../assets/js/material-dashboard.js?v=2.1.2" type="text/javascript"></script>
        <script src="../assets/vendor/jquery/jquery-3.2.1.min.js"></script>
        <!-- 합쳐지고 최소화된 최신 자바스크립트 -->
        <script src="https://maxcdn.bootstrapcdn.com/b ootstrap/3.3.2/js/bootstrap.min.js"></script>
        <!-- The core Firebase JS SDK is always required and must be listed first -->
        <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-app.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js">
        </script>
        <!-- TODO: Add SDKs for Firebase products that you want to use
       https://firebase.google.com/docs/web/setup#available-libraries -->
        <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-analytics.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-database.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-firestore.js"></script>
  
        <script src="../assets/js/firebaseInit.js"></script>
        <script type="text/javascript" src="../assets/js/myfunctions.js"></script>
        <script src="../assets/js/material-dashboard.js"></script>
        <script src="../assets/js/material-dashboard.js.map"></script>
        <script src="../assets/js/material-dashboard.min.js"></script>
        <script src="../assets/js/drawchart.js"></script>

        <!-- httpRequest JSON parsing script -->
        <script type="text/javascript">
          var firebaseEmailAuth = firebase.auth(); //파이어베이스 인증 객체
          var db = firebase.firestore();
            firebaseEmailAuth.onAuthStateChanged(user =>{
                var uid = firebaseEmailAuth.currentUser.uid;
                
                getDaily( uid); //일일 입고, 출고량 표시
                drawWeekDailyChart(uid); //최근 7일 생산, 거래량 그래프
                getStockNum(uid); //현재 재고량 표시
                md.initDashboardPageCharts(uid);

                var docRef = db.collection("users").doc(firebaseEmailAuth.currentUser.uid);
                docRef.get().then(function(doc) {
                    if (doc.exists) {
                        userAddr= doc.data().addr;
                        userName = doc.data().name;
                        document.getElementById("userInfo").innerHTML = userName + "님 환영합니다."+ "<br> 계좌 : "+userAddr;
                        //alert(doc.data().addr+" 입니다.");

                    } else {
                        // doc.data() will be undefined in this case
                        //console.log("No such document!");
                    }
                //getInventorySize();
            }).catch(err => {
                document.getElementById("userInfo").innerHTML = "로그인 실패  ERR: " + err;
            });
        });
            
      
            //일일 입고량 판매량 가져오는 함수
            function getDaily(uid) {
                var today = new Date();
                //today = today.getTime() + (9 * 60 * 60 * 1000);
                today = moment(today).format('YYYY-MM-DD');
                //console.log(today);
                var docRefEnter = db.collection("users").doc(uid).collection('daily').doc(
                    today);
                //console.log("today = ", today);
                var result = "";
                docRefEnter.get().then(function (doc) {
                    if (doc.exists) {
                        result = doc.data();
                        //console.log("Document data:", result["dailyEnter"]);
                        document.getElementById("entered").innerHTML = result["dailyEnter"]*500 + " <small>개</small>";
                        document.getElementById("released").innerHTML = result["dailyRelease"] + " <small>개</small>";

                    } else {
                        // doc.data() will be undefined in this case
                        //console.log("No such document!");
                        result = 0;
                        return;
                    }
                }).catch(function (error) {
                    //console.log("Error getting document:", error);
                });
          
              

            }

            async function getStockNum(uid) {
              var docRefSell = db.collection("users").doc(uid).collection("inventory");
              var count = 0;
              await docRefSell.get().then(snapshot=>{
                  snapshot.forEach(doc => {
                    if(doc.exists){
                      count+= doc.data().count;
                    }else{
                      //console.log("No tokenId in stock");
                    }
                  document.getElementById("stock").innerHTML = count + " <small>개</small>";
                  });
              });
            }

            function lastWeekDays() { //최근 7일 날짜 가져옴
                var days = new Array();
                
                for(var i=5; i>=0; i--){
                    var date = new Date();
                    //console.log(date);
                    var tmp = date.getTime() - (i * 24 * 60 * 60 * 1000)// + (9 * 60 * 60 * 1000);
                    date.setTime(tmp)
                    days.push(moment(date).format('YYYY-MM-DD'));
                }
                //console.log(days);
                return days;
            }

            function drawWeekDailyChart(uid){ // 7일간의 재고량 데이터 리턴
                var days = lastWeekDays();
                var docRef4 = db.collection("users").doc(uid).collection('daily');
                var entered = new Array(); //입고량
                var released = new Array(); //재고량
                //console.log(days);
                var chk;
                docRef4.get().then(snapshot => {
                    for(i in days){
                        chk = 0;
                        snapshot.forEach(doc => {
                            if(days[i] == doc.id){
                                entered.push(doc.data().dailyEnter * 500);
                                released.push(doc.data().dailyRelease);
                                chk = 1;
                            }
                        })
                        if(chk === 0){
                            entered.push(0);
                            released.push(0);
                        }
                    }
                    drawChart(days, entered, released);
                }).catch(err => {
                    //console.log("Err : " + err);
                });
            }

            function drawChart(days, entered, released) {// 차트그리기
                Highcharts.chart('container', {
                    credits: {
                        enabled: false
                    },
                    chart: {
                        type: 'column'
                    },
                    title: {
                        text: '입고량, 판매량 추이'
                    },
                    subtitle: {
                        text: 'from MaskSaver'
                    },
                    xAxis: {
                        categories: days,
                        crosshair: true
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: 'Quantity (개수)'
                        }
                    },
                    tooltip: {
                        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                            '<td style="padding:0"><b>{point.y:.f} 개</b></td></tr>',
                        footerFormat: '</table>',
                        shared: true,
                        useHTML: true
                    },
                    plotOptions: {
                        column: {
                            pointPadding: 0.2,
                            borderWidth: 0
                        }
                    },
                    series: [
                        {
                        name: '입고량',
                        data: entered

                    }, {
                        name: '판매량',
                        data: released

                    }]
                });
            }
            
/*
            $(document).ready(function () {
                // Javascript method's body can be found in assets/js/demos.js


            });
            */
        </script>
    </body>

</html>