<!doctype html>
<html lang="en">

<head>
    <title>Administrator page</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/data.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://code.highcharts.com/js/themes/grid-light.js"></script> <!-- chrom 탭-->
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <!--     Fonts and icons     -->
    <link rel="stylesheet" type="text/css"
        href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" />
    <!--     Fonts and icons     -->
    <link rel="stylesheet" type="text/css"
        href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
    <!-- Material Kit CSS -->
    <link href="../assets/css/material-dashboard.css?v=2.1.2" rel="stylesheet" />
    <!-- Material Dashboard CSS -->
    <link rel="stylesheet" href="../assets/css/material-dashboard?v=2.1.2.css">
    <style>
        .highcharts-figure,
        .highcharts-data-table table {
            min-width: 310px;
            max-width: 1200px;
            margin: 1em auto;
        }

        #container {
            height: 400px;
        }

        .highcharts-data-table table {
            font-family: Verdana, sans-serif;
            border-collapse: collapse;
            border: 1px solid #EBEBEB;
            margin: 10px auto;
            text-align: center;
            width: 100%;
            max-width: 500px;
        }

        .highcharts-data-table caption {
            padding: 1em 0;
            font-size: 1.2em;
            color: #555;
        }

        .highcharts-data-table th {
            font-weight: 600;
            padding: 0.5em;
        }

        .highcharts-data-table td,
        .highcharts-data-table th,
        .highcharts-data-table caption {
            padding: 0.5em;
        }

        .highcharts-data-table thead tr,
        .highcharts-data-table tr:nth-child(even) {
            background: #f8f8f8;
        }

        .highcharts-data-table tr:hover {
            background: #f1f7ff;
        }
    </style>
</head>

<body>

    <body>
        <div class="wrapper ">
            <div class="sidebar" data-color="purple" data-background-color="white">
                <!--
            Tip 1: You can change the color of the sidebar using: data-color="purple | azure | green | orange | danger"
      
            Tip 2: you can also add an image using data-image tag
        -->
                <div class="logo">
                    <a href="../index.html" class="simple-text logo-mini">
                        <img src="../assets/img/logo/logo.png" alt="">
                    </a>
                    <a class="simple-text logo-normal">
                        MaskSaver
                    </a>
                </div>
                <div class="sidebar-wrapper">
                    <ul class="nav">
                        <li class="nav-item active">
                            <a class="nav-link" href="../administrator/administrator_dashboard.html">
                                <i class="material-icons">dashboard</i>
                                <p>Dashboard</p>
                            </a>
                        </li>
                        <li class="nav-item ">
                            <a class="nav-link" href="../administrator/administrator_inventory.html">
                                <i class="material-icons">content_paste</i>
                                <p>업체별 재고 내역</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../administrator/administrator_receipt.html">
                                <i class="material-icons">content_paste</i>
                                <p>업체별 입고 내역</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../administrator/administrator_sold.html">
                                <i class="material-icons">content_paste</i>
                                <p>업체별 판매 내역</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link " href="../administrator/administrator_traceToken.html">
                                <i class="material-icons">content_paste</i>
                                <p>토큰별 유통 내역</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../administrator/administrator_warning.html">
                                <i class="material-icons">content_paste</i>
                                <p>업체별 경고 내역</p>
                            </a>
                        </li>
                        <!-- your sidebar here -->
                    </ul>
                </div>
            </div>
            <div class="main-panel">
                <!-- Navbar -->
                <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
                    <div class="container-fluid">
                        <div class="navbar-wrapper">
                            <a class="navbar-brand" href="javascript:;">Dashboard</a>
                            <div class="alert alert-info hr" role="alert">
                                <a id="userInfo">로그인시 유저 정보가 보입니다.</a>
                            </div>
                        </div>

                        <button class="navbar-toggler" type="button" data-toggle="collapse"
                            aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="navbar-toggler-icon icon-bar"></span>
                            <span class="navbar-toggler-icon icon-bar"></span>
                            <span class="navbar-toggler-icon icon-bar"></span>
                        </button>
                        <div class="collapse navbar-collapse justify-content-end">
                            <form class="navbar-form">
                                <div class="input-group no-border">
                                    <div class="ripple-container"></div>
                                    </button>
                                </div>
                            </form>

                        </div>
                    </div>
                </nav>
                <!-- End Navbar -->
                <div class="content">
                    <div class="container-fluid">
                        <div class="row"> <!-- 상단 카드부분 -->
                            <div class="col-md-4 col-sm-4">
                                <div class="card card-stats">
                                    <div class="card-header card-header-warning card-header-icon">
                                      <div class="card-icon">
                                          <i class="material-icons">warning</i>
                                      </div>
                                      <p class="card-category">현재 위반 마스크 개수</p>
                                      <h3 class="card-title" id="warning"> 가져오는중 ..</h3>
                                    </div>
                                    <div class="card-footer">
                                        <div class="stats">
                                            <i class="material-icons text-danger">warning</i>
                                            <a href="">다수의 위반 재고들이 존재합니다..</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
    
                            <div class="col-md-4 col-sm-4">
                                <div class="card card-stats">
                                    <div class="card-header card-header-success card-header-icon">
                                      <div class="card-icon">
                                        <i class="material-icons">engineering</i>
                                      </div>
                                      <p class="card-category">오늘의 전체 생산량</p>
                                      <h3 class="card-title" id="made"> 가져오는중 ..</h3>
                                    </div>
                                    <div class="card-footer">
                                        <div class="stats">
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
    
                            <div class="col-md-4 col-sm-4">
                                <div class="card card-stats">
                                    <div class="card-header card-header-info card-header-icon">
                                      <div class="card-icon">
                                        <i class="material-icons">local_pharmacy</i>
                                      </div>
                                      <p class="card-category">오늘의 전체 판매량</p>
                                      <h3 class="card-title" id="sold"> 가져오는중 ..</h3>
                                    </div>
                                    <div class="card-footer">
                                        <div class="stats">
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                          
                        </div>
                    </div>
                    
                    <figure class="highcharts-figure">
                        <div id="container">가져오는중..</div>
                    </figure>

                    <footer class="footer">
                        <div class="container-fluid">
                            <nav class="float-left">
                                <ul>
                                    <li>
                                        <a href="../index.html">
                                            MaskSaver
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </footer>
                </div>
            </div>




            <!--   Core JS Files   -->
            <script src="../assets/js/core/jquery.min.js" type="text/javascript"></script>
            <script src="../assets/js/core/popper.min.js" type="text/javascript"></script>
            <script src="../assets/js/core/bootstrap-material-design.min.js" type="text/javascript"></script>

            <!-- Plugin for the Perfect Scrollbar -->
            <script src="../assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>

            <!-- Plugin for the momentJs  -->
            <script src="../assets/js/plugins/moment.min.js"></script>

            <!--  Plugin for Sweet Alert -->
            <script src="../assets/js/plugins/sweetalert2.js"></script>

            <!-- Forms Validations Plugin -->
            <script src="../assets/js/plugins/jquery.validate.min.js"></script>

            <!--  Plugin for the Wizard, full documentation here: https://github.com/VinceG/twitter-bootstrap-wizard -->
            <script src="../assets/js/plugins/jquery.bootstrap-wizard.js"></script>

            <!--	Plugin for Select, full documentation here: http://silviomoreto.github.io/bootstrap-select -->
            <script src="../assets/js/plugins/bootstrap-selectpicker.js"></script>

            <!--  Plugin for the DateTimePicker, full documentation here: https://eonasdan.github.io/bootstrap-datetimepicker/ -->
            <script src="../assets/js/plugins/bootstrap-datetimepicker.min.js"></script>

            <!--  DataTables.net Plugin, full documentation here: https://datatables.net/    -->
            <script src="../assets/js/plugins/jquery.datatables.min.js"></script>

            <!--	Plugin for Tags, full documentation here: https://github.com/bootstrap-tagsinput/bootstrap-tagsinputs  -->
            <script src="../assets/js/plugins/bootstrap-tagsinput.js"></script>

            <!-- Plugin for Fileupload, full documentation here: http://www.jasny.net/bootstrap/javascript/#fileinput -->
            <script src="../assets/js/plugins/jasny-bootstrap.min.js"></script>

            <!--  Full Calendar Plugin, full documentation here: https://github.com/fullcalendar/fullcalendar    -->
            <script src="../assets/js/plugins/fullcalendar.min.js"></script>

            <!-- Vector Map plugin, full documentation here: http://jvectormap.com/documentation/ -->
            <script src="../assets/js/plugins/jquery-jvectormap.js"></script>

            <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
            <script src="../assets/js/plugins/nouislider.min.js"></script>

            <!-- Include a polyfill for ES6 Promises (optional) for IE11, UC Browser and Android browser support SweetAlert -->
            <script src="../https://cdnjs.cloudflare.com/ajax/libs/core-js/2.4.1/core.js"></script>

            <!-- Library for adding dinamically elements -->
            <script src="../assets/js/plugins/arrive.min.js"></script>

            <!--  Google Maps Plugin    -->
            <script src="../https://maps.googleapis.com/maps/api/js?key=YOUR_KEY_HERE"></script>

            <!-- Chartist JS -->
            <script src="../assets/js/plugins/chartist.min.js"></script>

            <!--  Notifications Plugin    -->
            <script src="../assets/js/plugins/bootstrap-notify.js"></script>

            <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
            <script src="../assets/js/material-dashboard.min.js?v=2.1.2" type="text/javascript"></script>
            <script src="../assets/vendor/jquery/jquery-3.2.1.min.js"></script>
            <!-- 합쳐지고 최소화된 최신 자바스크립트 -->
            <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
            <!-- The core Firebase JS SDK is always required and must be listed first -->
            <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-app.js"></script>
            <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js">
            </script>
            <!-- TODO: Add SDKs for Firebase products that you want to use
       https://firebase.google.com/docs/web/setup#available-libraries -->
            <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-analytics.js"></script>
            <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-auth.js"></script>
            <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-database.js"></script>
            <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-firestore.js"></script>
            <script src="../assets/js/firebaseInit.js"></script>
            <script src="../assets/js/myfunctions.js"></script>
            <script src="../assets/js/material-dashboard.js"></script>
            <script src="../assets/js/material-dashboard.js.map"></script>
            <script src="../assets/js/material-dashboard.min.js"></script>

            <!-- httpRequest JSON parsing script -->
            <script type="text/javascript">
            
                var firebaseEmailAuth = firebase.auth(); //파이어베이스 인증 객체
                var db = firebase.firestore();
                firebaseEmailAuth.onAuthStateChanged(function (user) {

                    if (user) {
                        //로그인 성공한 유저 id 확인해 보기 - firebase database에 접근해서 데이터 조회 하는 함수
                        var docRef = db.collection("users").doc(firebaseEmailAuth.currentUser.uid);

                        docRef.get().then(function (doc) {
                            if (doc.exists) {
                                userAddr = doc.data().addr;
                                userName = doc.data().name;
                                userEmail = user.email;
                                document.getElementById("userInfo").innerHTML = userName + "님 환영합니다.";
                                
                            } else {
                                // doc.data() will be undefined in this case
                                console.log("No such document!");
                            }
                        }).catch(function (error) {
                            console.log("Error getting document:", error);
                        });
                    }
                });

              
                var today = new Date();
                today = moment(today).format('YYYY-MM-DD');
                getDaily(today).then(result => {
                    document.getElementById("made").innerHTML = result[0] + "<small> 개</small>";
                    document.getElementById("sold").innerHTML = result[1]+ "<small> 개</small>";
                })
                getWarningAmount();
                drawWeekDailyChart();

                //일일 입고량 판매량 가져오는 함수
                async function getDaily(today) {
                    var userRef = db.collection("users")

                    var result = "";
                    var makerList = new Array();
                    var sellerList = new Array();
                    await userRef.get().then(snapshot => {
                        snapshot.forEach(doc => {
                            if (doc.exists) {
                                result = doc.data();

                                if(result.index === "manufacturer") makerList.push(doc.id);
                                if(result.index === "seller")  sellerList.push(doc.id);
                                
                            } else {
                                // doc.data() will be undefined in this case
                                console.log("No such document!");
                                return;
                            }
                        });
                    }).catch(function (error) {
                        console.log("Error getting document:", error);
                    });
                    var madeAmount = 0;
                    var soldAmount = 0;
                    for(i in makerList){
                        await userRef.doc(makerList[i]).collection("daily").doc(today).get().then(doc => {
                            result = doc.data();
                            try{
                                madeAmount += result["dailyEnter"]*500;
                            }catch{
                            }
                        })
                    }
                    for(i in sellerList){
                        await userRef.doc(sellerList[i]).collection("daily").doc(today).get().then(doc => {
                            result = doc.data();
                            try{
                                soldAmount += result["dailyRelease"];
                            }catch{
                            }
                        })
                    }
                    //document.getElementById("made").innerHTML = madeAmount + "<small> BOX</small>";
                    //document.getElementById("sold").innerHTML = soldAmount + "<small> 개</small>";
                    //console.log(today + " " + madeAmount + " "  + soldAmount);
                    return [madeAmount, soldAmount];
                }
                
                function getWarningAmount() {
                    var warningRef = db.collection("administrator").doc("warning").collection("warning");
                    warningRef.get().then(snapshot => {
                        document.getElementById("warning").innerHTML = snapshot.size + "<small> 개</small>";
                    })
                }

                function lastWeekDays() { //최근 7일 날짜 가져옴
                var days = new Array();
                
                for(var i=5; i>=0; i--){
                    var date = new Date();
                    //console.log(date);
                    var tmp = date.getTime() - (i * 24 * 60 * 60 * 1000)// + (9 * 60 * 60 * 1000);
                    date.setTime(tmp)
                    days.push(moment(date).format('YYYY-MM-DD'));
                }
                //console.log(days);
                return days;
            }

            async function drawWeekDailyChart(uid){ // 7일간의 재고량 데이터 리턴
                var days = lastWeekDays();
                var made = new Array(); //입고량
                var sold = new Array(); //재고량
                //console.log(days);
                for(i in days){
                    await getDaily(days[i]).then(result => {
                        made.push(result[0]);
                        sold.push(result[1]);
                    }).catch(err => {
                        console.log("Err : " + err);
                    });
                }
                drawChart(days, made, sold);
            }

            function drawChart(days, made, sold) {// 차트그리기
                Highcharts.chart('container', {
                    credits: {
                        enabled: false
                    },
                    chart: {
                        type: 'column'
                    },
                    title: {
                        text: '전체 생산량, 판매량 추이'
                    },
                    subtitle: {
                        text: 'from MaskSaver'
                    },
                    xAxis: {
                        categories: days,
                        crosshair: true
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: 'Quantity (낱개))'
                        }
                    },
                    tooltip: {
                        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                            '<td style="padding:0"><b>{point.y:.f} 개</b></td></tr>',
                        footerFormat: '</table>',
                        shared: true,
                        useHTML: true
                    },
                    plotOptions: {
                        column: {
                            pointPadding: 0.2,
                            borderWidth: 0
                        }
                    },
                    series: [
                        {
                        name: '생산량',
                        data: made

                    }, {
                        name: '판매량',
                        data: sold
                    }]
                });
            }
            </script>
    </body>

</html>