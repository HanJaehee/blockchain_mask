<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <script src="./web3.min.js"></script>
  <!-- <script src="./web3Init.js"></script> -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="./MyFunctions.js"></script>
  <!-- 합쳐지고 최소화된 최신 CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

  <!-- 부가적인 테마 -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">

  <style>
    body {
      height: 100%;
  color: #111;
  box-shadow: inset 0 0 5rem rgba(0, 0, 0, .5);
}
  </style>
  <meta charset="utf-8">
  <title>Seller Page</title>
</head>

<body>
  <div class="container" style="padding-top:20px">
    <form class="form-inline">
      <div class="form-group">
        <label class="sr-only" for="id">id</label>
        <p id="id"></p>
      </div>

    </form>
  </div>
  <h1 class="text-center">판매사 페이지</h1>
  <hr><br>
  <!-- 판매사 란 -->
  <div class="container">
    <div class="panel panel-default">
      <h1 class="text-center">재고내역</h1>
      <hr>
      <div class=".col-md-6 .col-md-offset-3">
        <div id="table-wrapper" style="height: 300px; overflow-y: scroll;">
          <table class="table table-hover" id="inventoryTable">
            <thead>
              <tr>
                <th>시간</th>
                <th>일련번호</th>
                <th>판매사</th>
                <th>유통사</th>
                <th>개수</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>시간</td>
                <td>123456789</td>
                <td>판매사1</td>
                <td>유통사1</td>
                <td>20</td>
              </tr>
              <tr>
                <td>시간</td>
                <td>123456789</td>
                <td>판매사1</td>
                <td>유통사1</td>
                <td>20</td>
              </tr>
              <tr>
                <td>시간</td>
                <td>123456789</td>
                <td>판매사1</td>
                <td>유통사1</td>
                <td>20</td>
              </tr>
              <tr>
                <td>시간</td>
                <td>123456789</td>
                <td>판매사1</td>
                <td>유통사1</td>
                <td>20</td>
              </tr>
              <tr>
                <td>시간</td>
                <td>123456789</td>
                <td>판매사1</td>
                <td>유통사1</td>
                <td>20</td>
              </tr>
              <tr>
                <td>시간</td>
                <td>123456789</td>
                <td>판매사1</td>
                <td>유통사1</td>
                <td>20</td>
              </tr>
              <tr>
                <td>시간</td>
                <td>123456789</td>
                <td>판매사1</td>
                <td>유통사1</td>
                <td>20</td>
              </tr>
              <tr>
                <td>시간</td>
                <td>123456789</td>
                <td>판매사1</td>
                <td>유통사1</td>
                <td>20</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 유통사 확인란 -->
  <br><br>
  <div class="container">
    <div class="panel panel-default">
      <h1 class="text-center">거래내역</h1>
      <hr>
      <div class=".col-md-6 .col-md-offset-3">
        <div id="table-wrapper" style="height: 300px; overflow-y: scroll;">
          <table class="table table-hover" id="transactionListTable">
            <thead>
              <tr>
                <th>시간</th>
                <th>일련번호</th>
                <th>판매사</th>
                <th>유통사</th>
                <th>개수</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>시간</td>
                <td>123456789</td>
                <td>판매사1</td>
                <td>유통사1</td>
                <td>20</td>
              </tr>
              <tr>
                <td>시간</td>
                <td>123456789</td>
                <td>판매사1</td>
                <td>유통사1</td>
                <td>20</td>
              </tr>
              <tr>
                <td>시간</td>
                <td>123456789</td>
                <td>판매사1</td>
                <td>유통사1</td>
                <td>20</td>
              </tr>
              <tr>
                <td>시간</td>
                <td>123456789</td>
                <td>판매사1</td>
                <td>유통사1</td>
                <td>20</td>
              </tr>
              <tr>
                <td>시간</td>
                <td>123456789</td>
                <td>판매사1</td>
                <td>유통사1</td>
                <td>20</td>
              </tr>
              <tr>
                <td>시간</td>
                <td>123456789</td>
                <td>판매사1</td>
                <td>유통사1</td>
                <td>20</td>
              </tr>
              <tr>
                <td>시간</td>
                <td>123456789</td>
                <td>판매사1</td>
                <td>유통사1</td>
                <td>20</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- 거래내역 확인 및 소비자 정보 추가 -->
  <br><br>
  <div class="container">
    <div class="panel panel-default">
      <h1 class="text-center">판매내역</h1>
      <div class=".col-md-6 .col-md-offset-3">
        <div id="table-wrapper" style="height: 300px; overflow-y: scroll;">
          <table class="table table-hover" id="buyerListTable">
            <thead>
              <tr>
                <th>판매시간</th>
                <th>일련번호</th>
                <th>이름</th>
                <th>주민번호</th>
                <th>개수</th>
              </tr>
            </thead>
            <tbody id="buyerListTableTBody">
              <!-- 판매내역 테이블 바디 -->
            </tbody>
          </table>
        </div>
        <div class="container" style="margin-bottom:50px">
          <form class="form-inline">
            <div class="form-group">
              <label for="serialNumber3">일련번호</label>
            </div>
            <input type="text" class="form-control" id="serialNumber3" placeholder="일련번호">
            <div class="form-group">
              <label for="count3">개수</label>
            </div>
            <input type="text" class="form-control" id="count3" placeholder="개수">
            <div class="form-group">
              <label for="name">이름</label>
            </div>
            <input type="text" class="form-control" id="name" placeholder="이름">
            <div class="form-group">
              <label for="civilNumber">주민번호</label>
            </div>
            <input type="text" class="form-control" id="civilNumber" placeholder="990101-1122334">
            <button type="button" class="btn btn-default" id="checkSales" onclick="SellMask()">확인</button>
          </form>
        </div>
      </div>
      <!-- 합쳐지고 최소화된 최신 자바스크립트 -->
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
      <!-- The core Firebase JS SDK is always required and must be listed first -->
      <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-app.js"></script>

      <!-- TODO: Add SDKs for Firebase products that you want to use
       https://firebase.google.com/docs/web/setup#available-libraries -->
      <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-analytics.js"></script>
      <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-auth.js"></script>
      <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-database.js"></script>
      <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-firestore.js"></script>
      <script src="./firebaseInit.js"></script>
      <script src="./firebaseUserCheck.js" charset="utf-8"></script>
      <script>
        userSessionCheck();
      </script>
      <script type="text/javascript">
        //재고 목록 테이블 만드는 함수
        function MakeInventoryTable() {

        }
        //거래내역 테이블 만드는 함수
        function MakeTransactionListTable() {

        }
        //구매자 리스트 테이블 만드는 함수
        function MakeBuyerListTable(serialNumber, count, name, civilNumber) {
          //DB저장하는 함수
          StoreBuyerListInDB();

          //테이블 만들기
          GetDataFromDB()
        }
        function ValidateCivilNumber(civilNumber){
  if(civilNumber.charAt(6) != "-"){
    return false;
  }
  else if(civilNumber.length != 14){
    return false;
  }
  return true;
}

        function StoreBuyerListInDB() {
          var serialNumber = document.getElementById("serialNumber3").value;
          var name = document.getElementById("name").value;
          var count = document.getElementById("count3").value;
          var civilNumber = document.getElementById("civilNumber").value;

          //DB에 시리얼넘버, 이름, 개수, 주민번호 넣기
          var docRef = db.collection("users").doc(firebaseEmailAuth.currentUser.uid);
          var docRef2 = db.collection("users").doc(firebaseEmailAuth.currentUser.uid).collection("buyers");
          var docRef3 = db.collection("observer").doc("purchase_record").collection("record_set");
          //로그인된 사용자가 seller인지 확인
          docRef.get().then(function(doc) {
            if (doc.exists) {
              if (doc.data().index != "seller") {
                alert('seller가 아니라면 등록할 수 없습니다! 돌아가세요!');
                return;
              }
              console.log("Document data:", doc.data());
            } else {
              // doc.data() will be undefined in this case
              console.log("No such document!");
              return;
            }
          }).catch(function(error) {
            console.log("Error getting document:", error);
          });
          //어느 칸이라도 비어있으면 안됨
          if (!serialNumber || !name || !count || !civilNumber) {
            alert('제대로 입력해주세요!');
            return;
          } 
          else if(count <0 || count >3){
            alert('1인당 3개 이하의 마스크만 구매 가능합니다! 다시 입력해주세요!');
            return;
          }
          else if(ValidateCivilNumber(civilNumber)){
            alert('주민번호가 유효하지 않습니다.');
            return;
          }
          else {
            //해당seller의 db에 저장
            docRef2.add({
                name: name,
                serialNumber: serialNumber,
                count: count,
                civilNumber: civilNumber,
                time: firebase.firestore.FieldValue.serverTimestamp()
              })
              .then(function(docRef) {
                console.log("Document written with ID: ", docRef.id);
                alert("seller 저장 완료!");
                setTimeout(GetDataFromDB(), 3000);
              })
              .catch(function(error) {
                console.error("Error adding document: ", error);
                alert("seller 저장 실패!");
              });
              //감사자인 observer db에 저장
              docRef3.add({
                name: name,
                serialNumber: serialNumber,
                count: count,
                civilNumber: civilNumber,
                time: firebase.firestore.FieldValue.serverTimestamp()
              })
              .then(function(docRef) {
                console.log("Document written with ID: ", docRef.id);
                alert("observer 저장 완료!");
                setTimeout(GetTransactionDataFromDB(), 3000);
              })
              .catch(function(error) {
                console.error("Error adding document: ", error);
                alert("observer 저장 실패!");
              });
          }
        }
        //마스크 판매
        function SellMask() {
          //결과가 ok라면 alert('ok') MakeBuyerListTable(serialNumber,  count,name,civilNumber) else alert('false') return

          var result = "ok";
          if (result == "ok") {
            alert('트랜잭션 성공');
            MakeBuyerListTable();
          } else {
            alert('트랜잭션 실패');
          }
        }
        //DB로부터 데이터를 가지고옴
        function GetDataFromDB() {
          var docRef = db.collection("users").doc(firebaseEmailAuth.currentUser.uid).collection("buyers");
          docRef.orderBy("time", "desc").get().then(function(querySnapshot) {
            var rowItem = "";
            $('#buyerListTableTBody').empty();
            querySnapshot.forEach(function(doc) {
              //console.log(doc.id, " => ", doc.data());
              // doc.data() is never undefined for query doc snapshots
              rowItem += "<tr><td>" + doc.data().time.toDate().toLocaleString() + "</td>";/**/
              rowItem += "<td>" + doc.data().serialNumber + "</td>";
              rowItem += "<td>" + doc.data().name + "</td>";
              rowItem += "<td>" + civilNumberEncode(doc.data().civilNumber + "") + "</td>";
              rowItem += "<td>" + doc.data().count + "</td></tr>";

            });
            $('#buyerListTableTBody').append(rowItem);
          });


        }
      </script>
      <script type="text/javascript">
      //인증 시간 지연으로 인해 만듬
      //인증 상태가 변화하면 GetDataFromDB() 함수 호출
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            // User is signed in.
            window.onload = GetDataFromDB();
          } else {
            // No user is signed in.
          }
        });
      </script>

</body>

</html>
